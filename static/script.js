let mediaRecorder;
let audioChunks = [];
let isRecording = false;

const UI_TEXT = {
  en: {
    identifyTitle: "üßë‚Äçüíª Identify Me via Face",
    inputMethod: "üß≠ Choose Input Method",
    speak: "üé§ Speak",
    type: "‚å®Ô∏è Type",
    submitText: "Submit Text",
    submitVoice: "Submit Voice",
    outputLang: "üåê Choose Output Language",
    output: "üì§ Output",
    submit: "‚úÖ Submit",
    register: "üÜï New user? Register here",
    news: "üì∞ Latest News",
    newsLabel: "How many news items to display:",
    btnRefreshNews: "üîÑ Refresh News",
    btnReadNews: "üó£ Read News",
    youSaid: "You said:",
    noSubmission: "No submission yet.",
    noneText: "(none)",
    optionSelectPrompt: "-- Select --"
  },
  es: {
    identifyTitle: "üßë‚Äçüíª Identif√≠cate con tu rostro",
    inputMethod: "üß≠ Elige m√©todo de entrada",
    speak: "üé§ Hablar",
    type: "‚å®Ô∏è Escribir",
    submitText: "Enviar texto",
    submitVoice: "Enviar voz",
    outputLang: "üåê Elige idioma de salida",
    output: "üì§ Salida",
    submit: "‚úÖ Enviar",
    register: "üÜï ¬øNuevo usuario? Reg√≠strate aqu√≠",
    news: "üì∞ Noticias recientes",
    newsLabel: "Cu√°ntas noticias mostrar:",
    btnRefreshNews: "üîÑ Actualizar noticias",
    btnReadNews: "üó£ Leer noticias",
    youSaid: "Dijiste:",
    noSubmission: "Nada enviado a√∫n.",
    noneText: "(ninguno)",
    optionSelectPrompt: "-- Seleccionar --"
  },
  fr: {
    identifyTitle: "üßë‚Äçüíª Identifiez-vous par visage",
    inputMethod: "üß≠ Choisir la m√©thode d'entr√©e",
    speak: "üé§ Parler",
    type: "‚å®Ô∏è Taper",
    submitText: "Soumettre le texte",
    submitVoice: "Soumettre la voix",
    outputLang: "üåê Choisir la langue de sortie",
    output: "üì§ R√©sultat",
    submit: "‚úÖ Soumettre",
    register: "üÜï Nouvel utilisateur ? Inscrivez-vous ici",
    news: "üì∞ Derni√®res nouvelles",
    newsLabel: "Nombre de nouvelles √† afficher:",
    btnRefreshNews: "üîÑ Actualiser",
    btnReadNews: "üó£ Lire les nouvelles",
    youSaid: "Vous avez dit :",
    noSubmission: "Aucune soumission encore.",
    noneText: "(aucun)",
    optionSelectPrompt: "-- Choisir --"
  },
  de: {
    identifyTitle: "üßë‚Äçüíª Gesichtserkennung zur Anmeldung",
    inputMethod: "üß≠ Eingabemethode w√§hlen",
    speak: "üé§ Sprechen",
    type: "‚å®Ô∏è Schreiben",
    submitText: "Text senden",
    submitVoice: "Sprache senden",
    outputLang: "üåê Ausgabesprache w√§hlen",
    output: "üì§ Ausgabe",
    submit: "‚úÖ Senden",
    register: "üÜï Neuer Benutzer? Hier registrieren",
    news: "üì∞ Neueste Nachrichten",
    newsLabel: "Anzahl der anzuzeigenden Nachrichten:",
    btnRefreshNews: "üîÑ Nachrichten aktualisieren",
    btnReadNews: "üó£ Nachrichten vorlesen",
    youSaid: "Du hast gesagt:",
    noSubmission: "Noch keine Eingabe.",
    noneText: "(keine)",
    optionSelectPrompt: "-- W√§hlen --"
  },
  zh: {
    identifyTitle: "üßë‚Äçüíª Èù¢ÈÉ®ËØÜÂà´ÁôªÂΩï",
    inputMethod: "üß≠ ÈÄâÊã©ËæìÂÖ•ÊñπÂºè",
    speak: "üé§ ËØ≠Èü≥ËæìÂÖ•",
    type: "‚å®Ô∏è ÊñáÂ≠óËæìÂÖ•",
    submitText: "Êèê‰∫§ÊñáÊú¨",
    submitVoice: "Êèê‰∫§ËØ≠Èü≥",
    outputLang: "üåê ÈÄâÊã©ËæìÂá∫ËØ≠Ë®Ä",
    output: "üì§ ËæìÂá∫ÂÜÖÂÆπ",
    submit: "‚úÖ Êèê‰∫§",
    register: "üÜï Êñ∞Áî®Êà∑ÔºüÁÇπÊ≠§Ê≥®ÂÜå",
    news: "üì∞ ÊúÄÊñ∞Êñ∞Èóª",
    newsLabel: "ÊòæÁ§∫ÁöÑÊñ∞ÈóªÊù°Êï∞Ôºö",
    btnRefreshNews: "üîÑ Âà∑Êñ∞Êñ∞Èóª",
    btnReadNews: "üó£ Êí≠Êä•Êñ∞Èóª",
    youSaid: "‰Ω†ËØ¥‰∫ÜÔºö",
    noSubmission: "Â∞öÊú™Êèê‰∫§„ÄÇ",
    noneText: "(Êó†)",
    optionSelectPrompt: "-- ËØ∑ÈÄâÊã© --"
  }
};

function switchLanguage(lang) {
  const t = UI_TEXT[lang] || UI_TEXT.en;

  const set = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.innerText = value;
  };

  set("identifyTitle", t.identifyTitle);
  set("labelInputMethod", t.inputMethod);
  set("btnSubmitText", t.submitText);
  set("btnSubmitVoice", t.submitVoice);
  set("labelOutputLang", t.outputLang);
  set("submitBtn", t.submit);
  set("registerLink", t.register);
  set("newsTitle", t.news);
  set("newsLabel", t.newsLabel);
  set("btnRefreshNews", t.btnRefreshNews);
  set("btnReadNews", t.btnReadNews);
  set("userSpeechLabel", t.youSaid);
  set("outputLabel", t.output);
  set("output", t.noSubmission);

  const selectPrompt = document.getElementById("optionSelectPrompt");
  if (selectPrompt) selectPrompt.textContent = t.optionSelectPrompt;

  const speak = document.getElementById("optionSpeak");
  if (speak) speak.textContent = t.speak;

  const type = document.getElementById("optionType");
  if (type) type.textContent = t.type;

  const none = document.getElementById("userSpeech");
  if (none && (none.textContent === "(none)" || none.innerText === "(none)")) {
    none.textContent = t.noneText || "(none)";
  }
}

async function startFacePreview() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    const video = document.getElementById("facePreview");
    if (video) {
      video.srcObject = stream;
    }
  } catch (e) {
    console.error("Camera preview failed:", e);
    alert("‚ö†Ô∏è Could not access camera for preview.");
  }
}

async function toggleRecording() {
  const recordBtn = document.getElementById("recordBtn");

  if (!isRecording) {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks, { type: "audio/wav" });
      document.getElementById("playback").src = URL.createObjectURL(blob);
      document.audioBlob = blob;
    };

    mediaRecorder.start();
    isRecording = true;
    recordBtn.innerText = "‚èπ Stop Recording";
  } else {
    mediaRecorder.stop();
    isRecording = false;
    recordBtn.innerText = "üé§ Start Recording";
  }
}

async function submitText() {
  const typedText = document.getElementById("manualInput").value.trim();
  const outputText = document.getElementById("output");
  const lang = document.getElementById("targetLang").value;
  const audioPlayer = document.getElementById("ttsPlayback");

  outputText.innerText = "Processing...";

  try {
    const res = await fetch("/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: typedText, lang: lang })
    });
    const data = await res.json();
    console.log("Detected or selected language:", data.lang);
    outputText.innerText = data.translated;
    if (data.audio_filename) {
      audioPlayer.src = "/static/" + data.audio_filename;
      audioPlayer.play();
    }
  } catch (e) {
    outputText.innerText = "‚ùå Something went wrong.";
  }
}

async function submitVoice() {
  const outputText = document.getElementById("output");
  const lang = document.getElementById("targetLang").value;
  const audioPlayer = document.getElementById("ttsPlayback");

  if (!document.audioBlob) {
    outputText.innerText = "‚ùå No voice recording available.";
    return;
  }

  outputText.innerText = "Processing voice...";

  try {
    const formData = new FormData();
    formData.append("audio", document.audioBlob, "speech.wav");
    formData.append("lang", lang);

    const res = await fetch("/submit", {
      method: "POST",
      body: formData
    });
    const data = await res.json();
    document.getElementById("userSpeech").innerText = data.user_input || "(unavailable)";
    outputText.innerText = data.translated;
        if (data.audio_filename) {
      audioPlayer.src = "/static/" + data.audio_filename;
      audioPlayer.play();
    }
  } catch (e) {
    outputText.innerText = "‚ùå Something went wrong.";
  }
}

async function getNews() {
  const lang = document.getElementById("targetLang").value;
  const count = document.getElementById("count").value;  // ‚úÖ define it first
  console.log("Requested count:", count);

  const newsList = document.getElementById("newsList");
  newsList.innerHTML = "Loading news...";

  try {
    const res = await fetch("/news", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ lang: lang, count: parseInt(count) })
    });
    const data = await res.json();
    newsList.innerHTML = "";

    data.headlines.forEach(item => {
      const li = document.createElement("li");
      li.innerHTML = `<a href="${item.url}" target="_blank">${item.title}</a>`;
      newsList.appendChild(li);
    });
  } catch (e) {
    newsList.innerHTML = "Failed to fetch news.";
  }
}

async function sendMessage() {
  const input = document.getElementById("chatInput").value.trim();
  const responsePara = document.getElementById("chatResponse");

  if (!input) {
    responsePara.innerText = "Please enter a message.";
    return;
  }

  responsePara.innerText = "Thinking...";

  try {
    const res = await fetch("/chatbot", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: input })
    });
    const data = await res.json();
    responsePara.innerText = "ü§ñ " + data.response;
  } catch (e) {
    responsePara.innerText = "‚ùå Failed to contact the chatbot.";
  }
}

async function readNews() {
  const lang = document.getElementById("targetLang").value;
  const count = document.getElementById("count").value;
  const newsAudio = document.getElementById("newsAudio");

  try {
    const res = await fetch("/read-news", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ lang: lang, count: parseInt(count) })
    });
    const data = await res.json();

    if (data.audio_filename) {
      newsAudio.src = "/static/" + data.audio_filename;
      newsAudio.play();
    } else {
      alert("üõë Could not generate news audio.");
    }
  } catch (e) {
    alert("‚ùå Failed to fetch or play news.");
  }
}

// Webcam capture and face recognition
async function captureAndIdentify() {
  const video = document.getElementById("facePreview");
  const canvas = document.createElement("canvas");
  const context = canvas.getContext("2d");

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;

    // Let camera warm up briefly
    await new Promise(resolve => setTimeout(resolve, 1000));

    // Capture image from video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Stop stream after capture
    stream.getTracks().forEach(track => track.stop());

    // Convert to blob
    const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg"));
    const formData = new FormData();
    formData.append("image", blob, "snapshot.jpg");

    // Send to /identify
    const res = await fetch("/identify", {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    if (data.success) {
      alert(`Welcome back, ${data.user}! Language set to ${data.lang}.`);

      // Update language dropdown
      document.getElementById("targetLang").value = data.lang;

      // üîÅ Switch UI text
      switchLanguage(data.lang);

      // üßπ Hide face ID card
      const card = document.getElementById("identifyCard");
      if (card) card.style.display = "none";

      // Stop preview if still active
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
    } else {
      alert(data.message || "Face not recognized.");
    }

  } catch (e) {
    console.error("Camera error or fetch failed:", e);
    alert("‚ö†Ô∏è Unable to access camera or identify.");
  }
}

function toggleInputMode() {
  const mode = document.getElementById("inputMode").value;
  const voiceDiv = document.getElementById("voiceInput");
  const textDiv = document.getElementById("textInput");

  if (mode === "voice") {
    voiceDiv.style.display = "block";
    textDiv.style.display = "none";
  } else if (mode === "text") {
    voiceDiv.style.display = "none";
    textDiv.style.display = "block";
  } else {
    voiceDiv.style.display = "none";
    textDiv.style.display = "none";
  }
}

function openModal() {
  document.getElementById("registerModal").style.display = "flex";

  // Start webcam for registration
  navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    document.getElementById("regPreview").srcObject = stream;
  }).catch(err => {
    alert("Camera access denied for registration.");
  });
}

function closeModal() {
  document.getElementById("registerModal").style.display = "none";

  // Stop webcam
  const stream = document.getElementById("regPreview").srcObject;
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
}

async function submitRegistration() {
  const name = document.getElementById("regName").value.trim();
  const lang = document.getElementById("regLang").value;
  const video = document.getElementById("regPreview");

  if (!name) {
    alert("Please enter your name.");
    return;
  }

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);

  const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg"));
  const formData = new FormData();
  formData.append("image", blob, "snapshot.jpg");
  formData.append("name", name);
  formData.append("lang", lang);

  const res = await fetch("/register-face", {
    method: "POST",
    body: formData
  });
  const data = await res.json();
  alert(data.message);

  if (data.success) {
    closeModal();
  }
}

window.onload = () => {
  startFacePreview();
};